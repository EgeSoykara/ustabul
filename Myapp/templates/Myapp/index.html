{% extends "base.html" %}
{% block content %}
<section class="hero-spotlight reveal-up">
  <div class="hero-layout">
    <div class="hero-copy">
      <span class="hero-badge"><i class="bi bi-lightning-charge-fill"></i>HIZLI USTA BUL</span>
      <h1>Mahallendeki En İyi Ustaları <span>Tek Ekranda</span> Görün</h1>
      <p>Kuzey Kıbrıs genelinde hizmet türüne göre filtreleyin, ustaları karşılaştırın ve dakikalar içinde talep açın.</p>
      <div class="hero-actions">
        <a class="btn hero-btn hero-btn-solid" href="#search-panel"><i class="bi bi-search me-1"></i>Usta Ara</a>
        {% if request.user.is_authenticated and not is_provider_user %}
          <a class="btn hero-btn hero-btn-outline" href="#talep-form"><i class="bi bi-send-check me-1"></i>Talep Aç</a>
        {% else %}
          <a class="btn hero-btn hero-btn-outline" href="{% url 'customer_login' %}"><i class="bi bi-box-arrow-in-right me-1"></i>Giriş Yap</a>
        {% endif %}
      </div>
      <div class="trust-ribbon">
        <span><i class="bi bi-shield-check"></i>Doğrulanmış Profiller</span>
        <span><i class="bi bi-stopwatch"></i>Hızlı Dönüş</span>
        <span><i class="bi bi-star"></i>Gerçek Müşteri Puanı</span>
      </div>
    </div>
    <aside class="hero-metrics">
      <div class="metric-card">
        <p class="metric-top"><i class="bi bi-people-fill"></i>Şu an platformda</p>
        <p class="metric-value">{{ providers|length }}</p>
        <p class="metric-note">aktif usta listeleniyor</p>
      </div>
      <div class="metric-card">
        <p class="metric-top"><i class="bi bi-headset"></i>Destek merkezi</p>
        <p class="metric-value">24/7</p>
        <p class="metric-note">anlık canlı destek</p>
      </div>
    </aside>
  </div>
</section>

<section class="status-strip reveal-up delay-1">
  <div class="status-item"><i class="bi bi-geo-alt-fill"></i>Şehir ve ilçe bazında filtreleme</div>
  <div class="status-item"><i class="bi bi-check2-circle"></i>Hizmet türüne göre net liste</div>
  <div class="status-item"><i class="bi bi-chat-left-dots-fill"></i>Talep sonrası hızlı eşleşme</div>
</section>

<section class="row g-4 align-items-start">
  <div class="col-xl-7">
    <div class="card panel-card shadow-sm reveal-up delay-1" id="search-panel">
      <div class="card-body">
        <h2 class="h5 mb-3 section-title"><i class="bi bi-search me-2"></i>Usta Ara</h2>
        <form method="get" class="row g-3 search-form" id="search-form">
          <div class="col-12">
            <label class="form-label">{{ search_form.query.label }}</label>
            <div class="search-query-row">
              {{ search_form.query }}
              <button type="submit" class="btn btn-main search-query-btn">
                <i class="bi bi-search me-1"></i>Ara
              </button>
            </div>
          </div>
          <div class="col-lg-6">
            <label class="form-label">{{ search_form.service_type.label }}</label>
            <div class="service-picker">
              <div class="service-filter-shell">
                <i class="bi bi-search"></i>
                <input
                  type="search"
                  class="service-filter-input"
                  data-service-type-filter
                  placeholder="Hizmet ara (örnek: klima, kombi, elektrik)"
                  autocomplete="off"
                >
              </div>
              {{ search_form.service_type }}
              <p class="service-picker-note mb-0">Yazarak filtreleyin veya öne çıkanlardan seçin.</p>
              {% if popular_service_types %}
                <div class="quick-service-wrap">
                  <span class="quick-service-label">Öne Çıkan Hizmetler</span>
                  <div class="quick-service-list">
                    {% for service_type in popular_service_types %}
                      <button type="button" class="quick-service-btn" data-service-choice="{{ service_type.id }}">
                        {{ service_type.name }}
                      </button>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
          <div class="col-lg-3">
            <label class="form-label">{{ search_form.city.label }}</label>
            {{ search_form.city }}
          </div>
          <div class="col-lg-3">
            <label class="form-label">{{ search_form.district.label }}</label>
            {{ search_form.district }}
          </div>
          <div class="col-md-4 col-lg-3">
            <label class="form-label">{{ search_form.min_rating.label }}</label>
            {{ search_form.min_rating }}
          </div>
          <div class="col-md-4 col-lg-3">
            <label class="form-label">{{ search_form.min_reviews.label }}</label>
            {{ search_form.min_reviews }}
          </div>
          <div class="col-md-4 col-lg-3">
            <label class="form-label">{{ search_form.sort_by.label }}</label>
            {{ search_form.sort_by }}
          </div>
          <div class="col-12 form-toolbar">
            <button type="submit" class="btn btn-primary btn-main"><i class="bi bi-funnel-fill me-1"></i>Filtrele</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card panel-card shadow-sm mt-4 reveal-up delay-2">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <h2 class="h5 mb-0 section-title"><i class="bi bi-person-workspace me-2"></i>Müsait Ustalar</h2>
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <form method="get" class="provider-page-size-form">
              {% for key, value in request.GET.items %}
                {% if key != "provider_page" and key != "provider_page_size" %}
                  <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endif %}
              {% endfor %}
              <label for="provider-page-size" class="small text-muted me-1">Sayfa boyutu</label>
              <select id="provider-page-size" name="provider_page_size" onchange="this.form.submit()">
                {% for size_option in provider_page_size_options %}
                  <option value="{{ size_option }}" {% if size_option == provider_page_size %}selected{% endif %}>{{ size_option }}</option>
                {% endfor %}
              </select>
            </form>
          </div>
        </div>
        <p class="small text-muted mb-3">
          Toplam {{ provider_total_count }} usta bulundu.
          Sayfa {{ provider_page_obj.number }} / {{ provider_page_obj.paginator.num_pages }}.
          Sıralama: {{ selected_sort_label }}.
        </p>
        {% if providers %}
          <div class="row g-3 provider-grid">
            {% for provider in providers %}
              <div class="col-md-6 col-xl-6">
                <article class="provider-card p-3 h-100">
                  <div class="d-flex align-items-start justify-content-between mb-3">
                    <div class="provider-head">
                      <span class="avatar-dot">{{ provider.full_name|slice:":1"|upper }}</span>
                      <div>
                        <h3 class="h6 mb-0">{{ provider.full_name }}</h3>
                      </div>
                    </div>
                    <span class="pill">
                      {% for service in provider.service_types.all %}
                        {{ service.name }}{% if not forloop.last %}, {% endif %}
                      {% empty %}
                        Hizmet belirtilmedi
                      {% endfor %}
                    </span>
                  </div>
                  <p class="small mb-1 provider-location"><i class="bi bi-geo-alt-fill me-1"></i>{{ provider.city }} / {{ provider.district }}</p>
                  <p class="small mb-1 provider-rating">
                    <i class="bi bi-star-fill me-1"></i>Ortalama Puan: {{ provider.rating }} / 5
                    <span class="rating-count">({{ provider.ratings_count }} değerlendirme)</span>
                  </p>
                  <div class="provider-bottom">
                    <p class="small mb-0 provider-phone"><i class="bi bi-telephone-fill me-1"></i><strong>{{ provider.phone }}</strong></p>
                    <div class="provider-actions">
                      <a href="{% url 'provider_detail' provider.id %}" class="btn btn-sm provider-profile-btn">Profili Gör</a>
                      <a href="tel:{{ provider.phone }}" class="btn btn-sm provider-call-btn" data-provider-call data-phone="{{ provider.phone }}">Ara</a>
                      <a href="#" class="btn btn-sm provider-whatsapp-btn" data-provider-whatsapp data-phone="{{ provider.phone }}" target="_blank" rel="noopener noreferrer">WhatsApp</a>
                    </div>
                  </div>
                  <p class="small text-muted provider-contact-help mb-0" data-provider-help hidden>
                    Masaüstünde arama açılmazsa WhatsApp'ı kullanın.
                  </p>
                </article>
              </div>
            {% endfor %}
          </div>
          {% if provider_page_obj.has_other_pages %}
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-3">
              <span class="small text-muted">Sayfa {{ provider_page_obj.number }} / {{ provider_page_obj.paginator.num_pages }}</span>
              <nav aria-label="Usta listesi sayfalama">
                <ul class="pagination pagination-sm mb-0">
                  <li class="page-item {% if not provider_page_obj.has_previous %}disabled{% endif %}">
                    <a class="page-link" href="{{ provider_page_query }}{% if provider_page_query %}&{% endif %}provider_page=1" aria-label="İlk">&laquo;&laquo;</a>
                  </li>
                  <li class="page-item {% if not provider_page_obj.has_previous %}disabled{% endif %}">
                    <a class="page-link" href="{{ provider_page_query }}{% if provider_page_query %}&{% endif %}provider_page={% if provider_page_obj.has_previous %}{{ provider_page_obj.previous_page_number }}{% else %}1{% endif %}" aria-label="Önceki">&laquo;</a>
                  </li>
                  <li class="page-item disabled"><span class="page-link">{{ provider_page_obj.number }}</span></li>
                  <li class="page-item {% if not provider_page_obj.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ provider_page_query }}{% if provider_page_query %}&{% endif %}provider_page={% if provider_page_obj.has_next %}{{ provider_page_obj.next_page_number }}{% else %}{{ provider_page_obj.paginator.num_pages }}{% endif %}" aria-label="Sonraki">&raquo;</a>
                  </li>
                  <li class="page-item {% if not provider_page_obj.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ provider_page_query }}{% if provider_page_query %}&{% endif %}provider_page={{ provider_page_obj.paginator.num_pages }}" aria-label="Son">&raquo;&raquo;</a>
                  </li>
                </ul>
              </nav>
            </div>
          {% endif %}
        {% else %}
          <p class="mb-0">Kriterlere uygun usta bulunamadı.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-xl-5">
    {% if not request.user.is_authenticated %}
      <div class="card panel-card shadow-sm sticky-form reveal-up delay-3 auth-gate-card" id="talep-form">
        <div class="card-body">
          <h2 class="h5 mb-3 section-title"><i class="bi bi-shield-lock-fill me-2"></i>Talep Açmak İçin Giriş Gerekli</h2>
          <p class="mb-3 auth-gate-note">Talep oluşturma sadece giriş yapan müşteriler için açıktır.</p>
          <div class="d-grid gap-2">
            <a href="{% url 'customer_login' %}" class="btn btn-main-dark w-100 auth-gate-login-btn">
              <i class="bi bi-box-arrow-in-right me-2"></i>Müşteri Girişi
            </a>
            <a href="{% url 'customer_signup' %}" class="btn w-100 auth-gate-signup-btn">
              <i class="bi bi-person-plus-fill me-2"></i>Hemen Kayıt Ol
            </a>
          </div>
        </div>
      </div>
    {% elif is_provider_user %}
      <div class="card panel-card shadow-sm sticky-form reveal-up delay-3">
        <div class="card-body">
          <h2 class="h5 mb-3 section-title"><i class="bi bi-tools me-2"></i>Usta Modu</h2>
          <p class="mb-3">Usta hesabı ile giriş yaptığınız için talep oluşturma kapalı.</p>
          <a href="{% url 'provider_requests' %}" class="btn btn-main-dark w-100">
            <i class="bi bi-briefcase-fill me-2"></i>Usta Paneline Git
          </a>
        </div>
      </div>
    {% else %}
      <div class="card panel-card shadow-sm sticky-form reveal-up delay-3" id="talep-form">
        <div class="card-body">
          <h2 class="h5 mb-3 section-title"><i class="bi bi-send-check-fill me-2"></i>Hizmet Talebi Oluştur</h2>
          {% if request.user.is_authenticated %}
            <p class="small text-muted mb-3"><i class="bi bi-person-check-fill me-1"></i>Giriş yaptığın için bilgiler otomatik dolduruldu.</p>
          {% endif %}
          <form method="post" action="{% url 'create_request' %}" class="row g-3" id="request-form">
            {% csrf_token %}
            <div class="honey-trap-field" aria-hidden="true">
              <label for="id_website_url">Website</label>
              <input type="text" id="id_website_url" name="website_url" tabindex="-1" autocomplete="off">
            </div>
            <div class="col-12">
              <label class="form-label">{{ request_form.customer_name.label }}</label>
              {{ request_form.customer_name }}
              {% for error in request_form.customer_name.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-12">
              <label class="form-label">{{ request_form.customer_phone.label }}</label>
              {{ request_form.customer_phone }}
              {% if request_form.customer_phone.help_text %}
                <div class="phone-field-guide">
                  <div class="phone-field-guide-title"><i class="bi bi-info-circle-fill me-1"></i>Telefon Formatı</div>
                  <p>{{ request_form.customer_phone.help_text }}</p>
                  <p class="mb-0">Boşluk veya tire kullansan da sistem numarayı otomatik düzeltir.</p>
                </div>
              {% endif %}
              {% for error in request_form.customer_phone.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-12">
              <label class="form-label">{{ request_form.service_type.label }}</label>
              <div class="service-picker">
                <div class="service-filter-shell">
                  <i class="bi bi-search"></i>
                  <input
                    type="search"
                    class="service-filter-input"
                    data-service-type-filter
                    placeholder="Hizmet ara (örnek: tesisat, boya, montaj)"
                    autocomplete="off"
                  >
                </div>
                {{ request_form.service_type }}
                <p class="service-picker-note mb-0">Yazarak filtreleyin veya öne çıkanlardan seçin.</p>
                {% if popular_service_types %}
                  <div class="quick-service-wrap">
                    <span class="quick-service-label">Öne Çıkan Hizmetler</span>
                    <div class="quick-service-list">
                      {% for service_type in popular_service_types %}
                        <button type="button" class="quick-service-btn" data-service-choice="{{ service_type.id }}">
                          {{ service_type.name }}
                        </button>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
              </div>
              {% for error in request_form.service_type.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ request_form.city.label }}</label>
              {{ request_form.city }}
              {% for error in request_form.city.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ request_form.district.label }}</label>
              {{ request_form.district }}
              {% for error in request_form.district.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-12">
              <label class="form-label">{{ request_form.details.label }}</label>
              {{ request_form.details }}
              {% if request_form.details.help_text %}
                <p class="small text-muted mt-1 mb-0">{{ request_form.details.help_text }}</p>
              {% endif %}
              {% for error in request_form.details.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-dark w-100 btn-main-dark"><i class="bi bi-send-fill me-2"></i>Talep Gönder</button>
            </div>
          </form>
        </div>
      </div>
    {% endif %}
  </div>
</section>
<script id="city-district-map" type="application/json">{{ city_district_map_json|safe }}</script>
<script>
  (function () {
    const cityDistrictMapElement = document.getElementById("city-district-map");
    const cityDistrictMap = cityDistrictMapElement ? JSON.parse(cityDistrictMapElement.textContent) : {};

    function setupServiceTypePickerByForm(formId) {
      const form = document.getElementById(formId);
      if (!form) return;

      const serviceSelect = form.querySelector("select[name='service_type']");
      if (!serviceSelect) return;

      const filterInput = form.querySelector("input[data-service-type-filter]");
      const quickButtons = form.querySelectorAll("button[data-service-choice]");
      const baseOptions = Array.from(serviceSelect.options).map(function (option) {
        return {
          value: option.value,
          text: option.textContent,
        };
      });

      function normalizeText(text) {
        return (text || "").toLocaleLowerCase("tr-TR");
      }

      function syncQuickButtons() {
        quickButtons.forEach(function (button) {
          const isActive = button.getAttribute("data-service-choice") === serviceSelect.value;
          button.classList.toggle("is-active", isActive);
        });
      }

      function renderOptions(query) {
        const previousValue = serviceSelect.value;
        const normalizedQuery = normalizeText(query).trim();
        serviceSelect.innerHTML = "";

        let matchCount = 0;
        baseOptions.forEach(function (item) {
          const isPlaceholder = item.value === "";
          const matches = normalizedQuery === "" || isPlaceholder || normalizeText(item.text).includes(normalizedQuery);
          if (!matches) return;

          const option = document.createElement("option");
          option.value = item.value;
          option.textContent = item.text;
          serviceSelect.appendChild(option);

          if (!isPlaceholder) matchCount += 1;
        });

        if (matchCount === 0) {
          serviceSelect.innerHTML = "";
          const emptyOption = document.createElement("option");
          emptyOption.value = "";
          emptyOption.textContent = "Eşleşen hizmet bulunamadı";
          serviceSelect.appendChild(emptyOption);
        }

        const selectedStillExists = Array.from(serviceSelect.options).some(function (option) {
          return option.value === previousValue;
        });
      serviceSelect.value = selectedStillExists ? previousValue : "";
        syncQuickButtons();
      }

      if (filterInput) {
        filterInput.addEventListener("input", function () {
          renderOptions(filterInput.value);
        });
        renderOptions(filterInput.value);
      }

      quickButtons.forEach(function (button) {
        button.addEventListener("click", function () {
          const serviceValue = button.getAttribute("data-service-choice") || "";
          if (filterInput) {
            filterInput.value = "";
            renderOptions("");
          }
          serviceSelect.value = serviceValue;
          serviceSelect.dispatchEvent(new Event("change", { bubbles: true }));
          syncQuickButtons();
        });
      });

      serviceSelect.addEventListener("change", syncQuickButtons);
      syncQuickButtons();
    }

    setupServiceTypePickerByForm("search-form");
    setupServiceTypePickerByForm("request-form");

    function setupCityDistrictByForm(formId) {
      const form = document.getElementById(formId);
      if (!form) return;

      const citySelect = form.querySelector("select[name='city']");
      const districtSelect = form.querySelector("select[name='district']");
      if (!citySelect || !districtSelect) return;

      function repopulateDistricts() {
        const selectedBefore = districtSelect.value;
        const city = citySelect.value;
        const districts = cityDistrictMap[city] || [];
        districtSelect.innerHTML = "";

        const emptyOption = document.createElement("option");
        emptyOption.value = "";
        emptyOption.textContent = "İlçe seçin";
        districtSelect.appendChild(emptyOption);

        const anyOption = document.createElement("option");
        anyOption.value = "Herhangi";
        anyOption.textContent = "Herhangi";
        districtSelect.appendChild(anyOption);

        districts.forEach(function (district) {
          const option = document.createElement("option");
          option.value = district;
          option.textContent = district;
          districtSelect.appendChild(option);
        });

        if (selectedBefore && districts.includes(selectedBefore)) {
          districtSelect.value = selectedBefore;
        } else {
          districtSelect.value = "";
        }
      }

      citySelect.addEventListener("change", repopulateDistricts);
      repopulateDistricts();
    }

    setupCityDistrictByForm("search-form");
    setupCityDistrictByForm("request-form");

  })();
</script>
<script>
  (function () {
    const callButtons = document.querySelectorAll("[data-provider-call]");
    const whatsappButtons = document.querySelectorAll("[data-provider-whatsapp]");
    if (!callButtons.length && !whatsappButtons.length) return;

    function normalizeDigits(phone) {
      return String(phone || "").replace(/\D+/g, "");
    }

    function toWhatsappPhone(phone) {
      const digits = normalizeDigits(phone);
      if (!digits) return "";
      if (digits.startsWith("90")) return digits;
      if (digits.startsWith("0") && digits.length === 11) return "90" + digits.slice(1);
      return digits;
    }

    const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent || "");

    whatsappButtons.forEach(function (button) {
      const whatsappPhone = toWhatsappPhone(button.dataset.phone || "");
      if (!whatsappPhone) {
        button.classList.add("disabled");
        button.setAttribute("aria-disabled", "true");
        button.removeAttribute("href");
        return;
      }
      button.href = "https://wa.me/" + whatsappPhone;
    });

    callButtons.forEach(function (button) {
      button.addEventListener("click", function () {
        if (isMobile) return;
        const card = button.closest(".provider-card");
        const help = card ? card.querySelector("[data-provider-help]") : null;
        if (!help) return;
        help.hidden = false;
        window.setTimeout(function () {
          help.hidden = true;
        }, 2400);
      });
    });

  })();
</script>
{% endblock %}
