{% extends "base.html" %}
{% block content %}
<section class="auth-wrap reveal-up">
  <div class="card panel-card auth-card shadow-sm">
    <div class="card-body p-4 p-md-5">
      <span class="hero-badge"><i class="bi bi-briefcase-fill"></i>USTA KAYDI</span>
      <h1 class="mt-3 mb-2">Usta Hesabı Oluştur</h1>
      <p class="text-muted mb-4">Kayıt sonrası talepleri panelden yönetebilir, teklif ve randevu sürecini başlatabilirsin.</p>

      <form method="post" class="row g-3">
        {% csrf_token %}
        <div class="col-md-6">
          <label class="form-label">{{ form.username.label }}</label>
          {{ form.username }}
          {% for error in form.username.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-md-6">
          <label class="form-label">{{ form.email.label }}</label>
          {{ form.email }}
          {% for error in form.email.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-md-6">
          <label class="form-label">{{ form.full_name.label }}</label>
          {{ form.full_name }}
          {% for error in form.full_name.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-md-6">
          <label class="form-label">{{ form.phone.label }}</label>
          {{ form.phone }}
          {% if form.phone.help_text %}
            <div class="phone-field-guide">
              <div class="phone-field-guide-title"><i class="bi bi-info-circle-fill me-1"></i>Telefon Formatı</div>
              <p>{{ form.phone.help_text }}</p>
              <p class="mb-0">Boşluk veya tire kullansan da sistem numarayı otomatik düzeltir.</p>
            </div>
          {% endif %}
          {% for error in form.phone.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-md-6">
          <label class="form-label">{{ form.city.label }}</label>
          {{ form.city }}
          {% for error in form.city.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-md-6">
          <label class="form-label">{{ form.district.label }}</label>
          {{ form.district }}
          {% for error in form.district.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-12">
          <label class="form-label">{{ form.service_types.label }}</label>
          {{ form.service_types }}
          {% if form.service_types.help_text %}
            <p class="small text-muted service-types-help mb-0 mt-1">{{ form.service_types.help_text }}</p>
          {% endif %}
          {% for error in form.service_types.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-12">
          <label class="form-label">{{ form.description.label }}</label>
          {{ form.description }}
          {% for error in form.description.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-md-6">
          <label class="form-label">{{ form.password1.label }}</label>
          {{ form.password1 }}
          {% for error in form.password1.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-md-6">
          <label class="form-label">{{ form.password2.label }}</label>
          {{ form.password2 }}
          {% for error in form.password2.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        {% if form.non_field_errors %}
          <div class="col-12">
            {% for error in form.non_field_errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        {% endif %}
        <div class="col-12">
          <button type="submit" class="btn auth-submit-btn w-100"><i class="bi bi-person-check-fill me-1"></i>Usta Hesabını Aç</button>
        </div>
      </form>

      <p class="small mt-4 mb-0 text-muted">
        Zaten usta hesabın var mı
        <a href="{% url 'provider_login' %}" class="auth-link">Giriş yap</a>
      </p>
    </div>
  </div>
</section>
<script id="city-district-map" type="application/json">{{ city_district_map_json|safe }}</script>
<script>
  (function () {
    const mapElement = document.getElementById("city-district-map");
    let cityDistrictMap = {};
    if (mapElement) {
      try {
        cityDistrictMap = JSON.parse(mapElement.textContent || "{}");
      } catch (error) {
        cityDistrictMap = {};
      }
    }
    const citySelect =
      document.getElementById("id_city") ||
      document.querySelector("select[name='city']");
    const districtSelect =
      document.getElementById("id_district") ||
      document.querySelector("select[name='district']");
    if (!citySelect || !districtSelect) return;

    function repopulateDistricts() {
      const selectedBefore = districtSelect.value;
      const city = citySelect.value;
      const districts = cityDistrictMap[city] || [];
      districtSelect.innerHTML = "";

      const emptyOption = document.createElement("option");
      emptyOption.value = "";
      emptyOption.textContent = "İlçe seçin";
      districtSelect.appendChild(emptyOption);

      districts.forEach(function (district) {
        const option = document.createElement("option");
        option.value = district;
        option.textContent = district;
        districtSelect.appendChild(option);
      });

      if (selectedBefore && districts.includes(selectedBefore)) {
        districtSelect.value = selectedBefore;
      } else {
        districtSelect.value = "";
      }
    }

    citySelect.addEventListener("change", repopulateDistricts);
    repopulateDistricts();
  })();
</script>
{% endblock %}
