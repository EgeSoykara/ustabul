{% extends "base.html" %}
{% block content %}
<section class="card panel-card provider-profile-section shadow-sm reveal-up mb-4">
  <div class="card-body p-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <h1 class="h4 mb-0"><i class="bi bi-person-vcard-fill me-2"></i>Usta Profili</h1>
      <div class="d-flex align-items-center flex-wrap gap-2 provider-profile-toolbar">
        <a href="{% url 'account_settings' %}" class="btn btn-outline-secondary">
          <i class="bi bi-gear me-1"></i>Hesap Ayarları
        </a>
        <a href="{% url 'provider_detail' provider.id %}" class="btn btn-main">
          <i class="bi bi-eye-fill me-1"></i>Profili Müşteri Gibi Gör
        </a>
      </div>
    </div>
    <p class="mb-0 text-muted">Buradan hizmet alanlarını ve iletişim bilgilerini güncelleyebilirsin.</p>
    <div class="mt-3 d-flex align-items-center gap-2 flex-wrap">
      {% if provider.is_verified %}
        <span class="status-pill status-completed"><i class="bi bi-patch-check-fill me-1"></i>Dogrulanmis Usta</span>
      {% else %}
        <span class="status-pill status-pending_provider"><i class="bi bi-hourglass-split me-1"></i>Dogrulama Bekliyor</span>
      {% endif %}
      {% if provider.verified_at %}
        <span class="small text-muted">Onay tarihi: {{ provider.verified_at|date:"d.m.Y H:i" }}</span>
      {% endif %}
    </div>
  </div>
</section>

<section class="auth-wrap reveal-up provider-profile-section">
  <div class="card panel-card auth-card shadow-sm">
    <div class="card-body p-4 p-md-5">
      <form method="post" class="row g-3">
        {% csrf_token %}
        <div class="col-md-6">
          <label class="form-label">{{ form.full_name.label }}</label>
          {{ form.full_name }}
          {% for error in form.full_name.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-md-6">
          <label class="form-label">{{ form.phone.label }}</label>
          {{ form.phone }}
          {% if form.phone.help_text %}
            <div class="phone-field-guide">
              <div class="phone-field-guide-title"><i class="bi bi-info-circle-fill me-1"></i>Telefon Formatı</div>
              <p>{{ form.phone.help_text }}</p>
              <p class="mb-0">Boşluk veya tire kullansan da sistem numarayı otomatik düzeltir.</p>
            </div>
          {% endif %}
          {% for error in form.phone.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-md-4">
          <label class="form-label">{{ form.city.label }}</label>
          {{ form.city }}
          {% for error in form.city.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-md-4">
          <label class="form-label">{{ form.district.label }}</label>
          {{ form.district }}
          {% for error in form.district.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-md-4">
          <label class="form-label">{{ form.is_available.label }}</label>
          {{ form.is_available }}
          {% for error in form.is_available.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-12">
          <label class="form-label">{{ form.service_types.label }}</label>
          {{ form.service_types }}
          {% if form.service_types.help_text %}
            <p class="small text-muted service-types-help mt-2 mb-1">{{ form.service_types.help_text }}</p>
          {% endif %}
          {% for error in form.service_types.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="col-12">
          <label class="form-label">{{ form.description.label }}</label>
          {{ form.description }}
          {% for error in form.description.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        {% if form.non_field_errors %}
          <div class="col-12">
            {% for error in form.non_field_errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        {% endif %}
        <div class="col-12">
          <button type="submit" class="btn auth-submit-btn w-100">
            <i class="bi bi-save2-fill me-1"></i>Profili Kaydet
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

{% if calendar_enabled %}
<section class="card panel-card provider-profile-section shadow-sm reveal-up mt-4">
  <div class="card-body p-4">
    <h2 class="h5 mb-3"><i class="bi bi-calendar-week me-2"></i>Haftalik Musaitlik</h2>
    <form method="post" class="row g-2 align-items-end mb-3 provider-availability-form">
      {% csrf_token %}
      <input type="hidden" name="slot_action" value="add">
      <div class="col-md-3">
        <label class="form-label">{{ availability_form.weekday.label }}</label>
        {{ availability_form.weekday }}
      </div>
      <div class="col-md-3">
        <label class="form-label">{{ availability_form.start_time.label }}</label>
        {{ availability_form.start_time }}
      </div>
      <div class="col-md-3">
        <label class="form-label">{{ availability_form.end_time.label }}</label>
        {{ availability_form.end_time }}
      </div>
      <div class="col-md-2">
        <label class="form-label">{{ availability_form.is_active.label }}</label>
        {{ availability_form.is_active }}
      </div>
      <div class="col-md-1 d-grid">
        <button type="submit" class="btn btn-main"><i class="bi bi-plus-lg"></i></button>
      </div>
      {% if availability_form.non_field_errors %}
        <div class="col-12">
          {% for error in availability_form.non_field_errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}
    </form>

    {% if availability_slots %}
      <div class="table-responsive">
        <table class="table request-table align-middle mb-0">
          <thead>
            <tr>
              <th>Gun</th>
              <th>Baslangic</th>
              <th>Bitis</th>
              <th>Durum</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for slot in availability_slots %}
              <tr>
                <td data-label="Gün">{{ slot.get_weekday_display }}</td>
                <td data-label="Başlangıç">{{ slot.start_time|time:"H:i" }}</td>
                <td data-label="Bitiş">{{ slot.end_time|time:"H:i" }}</td>
                <td data-label="Durum">
                  {% if slot.is_active %}
                    <span class="status-pill status-completed">Aktif</span>
                  {% else %}
                    <span class="status-pill status-cancelled">Pasif</span>
                  {% endif %}
                </td>
                <td data-label="İşlem">
                  <form method="post" class="m-0">
                    {% csrf_token %}
                    <input type="hidden" name="slot_action" value="delete">
                    <input type="hidden" name="slot_id" value="{{ slot.id }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash3 me-1"></i>Sil</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="mb-0 text-muted">Henuz musaitlik araligi eklenmedi. Eklersen musteriler sadece uygun saatleri secer.</p>
    {% endif %}
  </div>
</section>
{% endif %}

<script id="city-district-map" type="application/json">{{ city_district_map_json|safe }}</script>
<script>
  (function () {
    const mapElement = document.getElementById("city-district-map");
    const cityDistrictMap = mapElement ? JSON.parse(mapElement.textContent) : {};
    const citySelect = document.getElementById("id_city");
    const districtSelect = document.getElementById("id_district");
    if (!citySelect || !districtSelect) return;

    function repopulateDistricts() {
      const selectedBefore = districtSelect.value;
      const city = citySelect.value;
      const districts = cityDistrictMap[city] || [];
      districtSelect.innerHTML = "";

      districts.forEach(function (district) {
        const option = document.createElement("option");
        option.value = district;
        option.textContent = district;
        districtSelect.appendChild(option);
      });

      if (selectedBefore && districts.includes(selectedBefore)) {
        districtSelect.value = selectedBefore;
      } else if (districts.length > 0) {
        districtSelect.value = districts[0];
      }
    }

    citySelect.addEventListener("change", repopulateDistricts);
    repopulateDistricts();
  })();
</script>
{% endblock %}
