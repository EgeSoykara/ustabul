{% extends "base.html" %}
{% block content %}
<section class="card panel-card shadow-sm reveal-up my-requests-section">
  <div class="card-body p-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <h1 class="h4 mb-0"><i class="bi bi-kanban me-2"></i>Taleplerim</h1>
      <div class="d-flex align-items-center gap-2 my-requests-toolbar">
        {% if cancelled_count %}
          <form method="post" action="{% url 'delete_all_cancelled_requests' %}" class="m-0">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger">
              <i class="bi bi-trash3 me-1"></i>İptalleri Sil ({{ cancelled_count }})
            </button>
          </form>
        {% endif %}
        <a class="btn btn-outline-secondary" href="{% url 'agreement_history' %}">
          <i class="bi bi-journal-check me-1"></i>Anlaşma Geçmişi
        </a>
        <a class="btn btn-outline-secondary" href="{% url 'account_settings' %}">
          <i class="bi bi-gear me-1"></i>Hesap Ayarları
        </a>
        <a class="btn btn-main" href="{% url 'request_form_page' %}"><i class="bi bi-plus-circle me-1"></i>Yeni Talep</a>
      </div>
    </div>
    <div class="customer-simple-guide mb-3" role="note" aria-label="Müşteri süreç rehberi">
      <strong><i class="bi bi-info-circle-fill me-1"></i>Akış:</strong>
      <ol class="simple-guide-list mb-0">
        <li>Usta teklifini bekleyin.</li>
        <li>Ustanızı seçin.</li>
        {% if calendar_enabled %}
          <li>Randevuyu oluşturup usta onayını bekleyin.</li>
        {% else %}
          <li>Mesajlaşma ile iş detayını netleştirin.</li>
        {% endif %}
        <li>İş bitince tamamlandı olarak kapatın.</li>
      </ol>
    </div>
    <section class="customer-kpi-grid mb-3" aria-label="Süreç özeti">
      <article class="customer-kpi-card">
        <div class="customer-kpi-title">Usta Yanıtı Bekleyen</div>
        <div class="customer-kpi-value">{{ customer_flow_summary.waiting_provider_count }}</div>
        <div class="customer-kpi-note">Teklif aşamasındaki talepler.</div>
      </article>
      <article class="customer-kpi-card">
        <div class="customer-kpi-title">Seçiminizi Bekleyen</div>
        <div class="customer-kpi-value">{{ customer_flow_summary.waiting_customer_selection_count }}</div>
        <div class="customer-kpi-note">Usta seçmeniz gereken talepler.</div>
      </article>
      <article class="customer-kpi-card">
        <div class="customer-kpi-title">Aktif Eşleşme</div>
        <div class="customer-kpi-value">{{ customer_flow_summary.active_matched_count }}</div>
        <div class="customer-kpi-note">Devam eden işler.</div>
      </article>
      {% if calendar_enabled %}
        <article class="customer-kpi-card">
          <div class="customer-kpi-title">Usta Onayı Bekleyen</div>
          <div class="customer-kpi-value">{{ customer_flow_summary.waiting_provider_appointment_count }}</div>
          <div class="customer-kpi-note">Randevusu usta onayında olanlar.</div>
        </article>
      {% endif %}
    </section>
    {% if requests %}
      <div class="table-responsive">
        <table class="table request-table align-middle mb-0">
          <thead>
            <tr>
              <th>Tarih</th>
              <th>Hizmet</th>
              <th>Konum</th>
              <th>Durum</th>
              <th>Eşleşen Usta</th>
              {% if calendar_enabled %}
                <th>Randevu</th>
              {% endif %}
              <th>İşlemler</th>
            </tr>
          </thead>
          <tbody>
            {% for item in requests %}
              <tr class="request-row-card">
                <td data-label="Tarih">{{ item.created_at|date:"d.m.Y H:i" }}</td>
                <td data-label="Hizmet">{{ item.service_type.name }}</td>
                <td data-label="Konum">{{ item.city }} / {{ item.district }}</td>
                <td data-label="Durum">
                  <div class="request-status-mobile-wrap">
                    <span class="status-pill status-{{ item.status }}">{{ item.get_status_display }}</span>
                    <button
                      type="button"
                      class="request-mobile-toggle"
                      data-request-mobile-toggle
                      aria-expanded="false"
                    >
                      Detaylar
                    </button>
                  </div>
                  <div class="request-flow-chip flow-{{ item.flow_tone }}">
                    <span class="request-flow-step">{{ item.flow_step }}</span>
                    <span class="request-flow-title">{{ item.flow_title }}</span>
                  </div>
                  <div class="request-flow-hint">{{ item.flow_hint }}</div>
                </td>
                <td data-label="Eşleşen Usta">
                  {% if item.matched_provider %}
                    {{ item.matched_provider.full_name }} ({{ item.matched_provider.phone }})
                    {% if item.matched_at %}
                      <br><span class="small text-muted">Anlaşma zamanı: {{ item.matched_at|date:"d.m.Y H:i" }}</span>
                    {% endif %}
                  {% elif item.status == "pending_customer" and item.accepted_offers %}
                    {{ item.accepted_offers|length }} teklif geldi
                  {% elif item.status == "pending_provider" and item.pending_offer %}
                    Ustalardan teklif yanıtı bekleniyor
                  {% else %}
                    Henüz eşleşmedi
                  {% endif %}
                </td>
                {% if calendar_enabled %}
                <td data-label="Randevu">
                  {% if item.appointment_entry %}
                    <div class="small fw-semibold">{{ item.appointment_entry.scheduled_for|date:"d.m.Y H:i" }}</div>
                    <span class="status-pill appointment-status appointment-{{ item.appointment_entry.status }}">
                      {{ item.appointment_entry.get_status_display }}
                    </span>
                    {% if item.appointment_entry.customer_note %}
                      <div class="small text-muted mt-1">Not: {{ item.appointment_entry.customer_note }}</div>
                    {% endif %}
                    {% if item.appointment_entry.provider_note %}
                      <div class="small text-muted">Usta notu: {{ item.appointment_entry.provider_note }}</div>
                    {% endif %}
                  {% elif item.status == "matched" %}
                    <span class="small text-muted">Randevu bekleniyor. Usta sizden saat seçmenizi bekliyor.</span>
                  {% else %}
                    <span class="small text-muted">-</span>
                  {% endif %}
                </td>
                {% endif %}
                <td data-label="İşlemler">
                  {% if item.status == "matched" %}
                    <div class="request-actions-stack">
                      <div class="request-action-guide">
                        <i class="bi bi-signpost-split me-1"></i>Sıradaki adım: {{ item.flow_next_action }}
                      </div>
                      <div class="request-action-group">
                        <div class="request-action-title">İletişim</div>
                        <a href="{% url 'request_messages' item.id %}" class="btn btn-sm nav-ghost-btn">
                          <i class="bi bi-chat-dots me-1"></i>Mesajlar
                          {% if item.unread_messages %}
                            <span class="chat-unread-badge">{{ item.unread_messages }}</span>
                          {% endif %}
                        </a>
                      </div>

                      <div class="request-action-group">
                        <div class="request-action-title">İş Durumu</div>
                        {% if item.can_complete_now %}
                          <form
                            method="post"
                            action="{% url 'complete_request' item.id %}"
                            class="m-0"
                            data-complete-confirm-form
                          >
                            {% csrf_token %}
                            <button type="button" class="btn btn-sm request-complete-btn" data-complete-open>
                              <i class="bi bi-check2-circle me-1"></i>Tamamlandı
                            </button>
                            <div class="request-complete-inline-confirm d-none" data-complete-confirm-box>
                              <div class="request-complete-inline-text">Bu işi tamamlandı olarak işaretlemeyi onaylıyor musunuz</div>
                              <div class="request-complete-inline-actions">
                                <button type="submit" class="btn btn-sm request-complete-confirm-btn">
                                  <i class="bi bi-check2-circle me-1"></i>Evet, Onayla
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-complete-cancel>
                                  Vazgeç
                                </button>
                              </div>
                            </div>
                          </form>
                        {% else %}
                          <div class="request-action-note">
                            <i class="bi bi-hourglass-split me-1"></i>Şu an tamamlanamaz
                          </div>
                          {% if item.complete_block_reason %}
                            <div class="request-action-note">{{ item.complete_block_reason }}</div>
                          {% endif %}
                        {% endif %}
                      </div>

                      {% if calendar_enabled %}
                      <details class="request-action-collapse" {% if not item.appointment_entry or item.appointment_entry.status == "pending_customer" %}open{% endif %}>
                        <summary><i class="bi bi-calendar3 me-1"></i>Randevu İşlemleri</summary>
                        <div class="request-action-collapse-body">
                          {% if item.appointment_entry %}
                            {% if item.appointment_entry.status == "pending" or item.appointment_entry.status == "pending_customer" or item.appointment_entry.status == "confirmed" %}
                              {% if item.appointment_entry.status == "pending_customer" %}
                                <div class="request-action-note">
                                  <i class="bi bi-patch-check me-1"></i>Randevu son onay aşamasında görünüyor. Gerekirse saati güncelleyebilirsiniz.
                                </div>
                              {% endif %}
                              {% if item.cancel_policy_note %}
                                <div class="request-action-note request-action-note-{{ item.cancel_policy_tone }}">
                                  <i class="bi bi-exclamation-triangle me-1"></i>{{ item.cancel_policy_note }}
                                </div>
                              {% endif %}
                              <form
                                method="post"
                                action="{% url 'cancel_appointment' item.id %}"
                                class="m-0"
                                data-cancel-confirm-form
                              >
                                {% csrf_token %}
                                <button type="button" class="btn btn-sm btn-outline-danger" data-cancel-open>
                                  <i class="bi bi-calendar-x me-1"></i>Randevuyu İptal Et
                                </button>
                                <div class="request-complete-inline-confirm d-none" data-cancel-confirm-box>
                                  <div class="request-complete-inline-text">Randevuyu iptal etmek istediğinize emin misiniz</div>
                                  <div class="request-complete-inline-actions">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                      <i class="bi bi-x-circle me-1"></i>Evet, İptal Et
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-cancel-cancel>
                                      Vazgeç
                                    </button>
                                  </div>
                                </div>
                              </form>
                              <form method="post" action="{% url 'create_appointment' item.id %}" class="appointment-create-form">
                                {% csrf_token %}
                                <div class="appointment-scheduler" data-appointment-scheduler>
                                  <div class="appointment-scheduler-title">Hızlı randevu</div>
                                  {% if item.provider_availability_slots %}
                                    <div class="appointment-availability-hint">
                                      Usta musaitligi:
                                      {% for slot in item.provider_availability_slots %}
                                        {{ slot.get_weekday_display }} {{ slot.start_time|time:"H:i" }}-{{ slot.end_time|time:"H:i" }}{% if not forloop.last %}, {% endif %}
                                      {% endfor %}
                                    </div>
                                  {% endif %}
                                  <input type="hidden" name="appointment_preset" value="" data-appointment-preset-input>
                                  <div class="appointment-quick-grid">
                                    <button type="button" class="appointment-quick-btn" data-appointment-preset-btn="now">Şimdi</button>
                                    <button type="button" class="appointment-quick-btn" data-appointment-preset-btn="30m">+30 dk</button>
                                    <button type="button" class="appointment-quick-btn" data-appointment-preset-btn="1h">+1 saat</button>
                                    <button type="button" class="appointment-quick-btn" data-appointment-preset-btn="2h">+2 saat</button>
                                  </div>
                                  <label class="appointment-detail-label" for="appointment-datetime-{{ item.id }}">
                                    veya detaylı tarih/saat seç
                                  </label>
                                  <input
                                    id="appointment-datetime-{{ item.id }}"
                                    type="datetime-local"
                                    name="scheduled_for"
                                    value="{{ item.appointment_entry.scheduled_for|date:'Y-m-d\\TH:i' }}"
                                    data-appointment-datetime
                                  >
                                  <div class="appointment-summary" data-appointment-summary></div>
                                </div>
                                <textarea name="customer_note" rows="2" placeholder="Randevu notu (isteğe bağlı)">{{ item.appointment_entry.customer_note }}</textarea>
                                <button type="submit" class="btn btn-sm btn-main">
                                  <i class="bi bi-calendar-event me-1"></i>Randevuyu Güncelle
                                </button>
                              </form>
                            {% elif item.appointment_entry.status == "rejected" or item.appointment_entry.status == "cancelled" %}
                              <form method="post" action="{% url 'create_appointment' item.id %}" class="appointment-create-form">
                                {% csrf_token %}
                                <div class="appointment-scheduler" data-appointment-scheduler>
                                  <div class="appointment-scheduler-title">Hızlı randevu</div>
                                  {% if item.provider_availability_slots %}
                                    <div class="appointment-availability-hint">
                                      Usta musaitligi:
                                      {% for slot in item.provider_availability_slots %}
                                        {{ slot.get_weekday_display }} {{ slot.start_time|time:"H:i" }}-{{ slot.end_time|time:"H:i" }}{% if not forloop.last %}, {% endif %}
                                      {% endfor %}
                                    </div>
                                  {% endif %}
                                  <input type="hidden" name="appointment_preset" value="" data-appointment-preset-input>
                                  <div class="appointment-quick-grid">
                                    <button type="button" class="appointment-quick-btn" data-appointment-preset-btn="now">Şimdi</button>
                                    <button type="button" class="appointment-quick-btn" data-appointment-preset-btn="30m">+30 dk</button>
                                    <button type="button" class="appointment-quick-btn" data-appointment-preset-btn="1h">+1 saat</button>
                                    <button type="button" class="appointment-quick-btn" data-appointment-preset-btn="2h">+2 saat</button>
                                  </div>
                                  <label class="appointment-detail-label" for="appointment-datetime-retry-{{ item.id }}">
                                    veya detaylı tarih/saat seç
                                  </label>
                                  <input
                                    id="appointment-datetime-retry-{{ item.id }}"
                                    type="datetime-local"
                                    name="scheduled_for"
                                    data-appointment-datetime
                                  >
                                  <div class="appointment-summary" data-appointment-summary></div>
                                </div>
                                <textarea name="customer_note" rows="2" placeholder="Randevu notu (isteğe bağlı)"></textarea>
                                <button type="submit" class="btn btn-sm btn-main">
                                  <i class="bi bi-calendar-plus me-1"></i>Tekrar Randevu Al
                                </button>
                              </form>
                            {% endif %}
                          {% else %}
                            <form method="post" action="{% url 'create_appointment' item.id %}" class="appointment-create-form">
                              {% csrf_token %}
                              <div class="appointment-scheduler" data-appointment-scheduler>
                                <div class="appointment-scheduler-title">Hızlı randevu</div>
                                {% if item.provider_availability_slots %}
                                  <div class="appointment-availability-hint">
                                    Usta musaitligi:
                                    {% for slot in item.provider_availability_slots %}
                                      {{ slot.get_weekday_display }} {{ slot.start_time|time:"H:i" }}-{{ slot.end_time|time:"H:i" }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                  </div>
                                {% endif %}
                                <input type="hidden" name="appointment_preset" value="" data-appointment-preset-input>
                                <div class="appointment-quick-grid">
                                  <button type="button" class="appointment-quick-btn" data-appointment-preset-btn="now">Şimdi</button>
                                  <button type="button" class="appointment-quick-btn" data-appointment-preset-btn="30m">+30 dk</button>
                                  <button type="button" class="appointment-quick-btn" data-appointment-preset-btn="1h">+1 saat</button>
                                  <button type="button" class="appointment-quick-btn" data-appointment-preset-btn="2h">+2 saat</button>
                                </div>
                                <label class="appointment-detail-label" for="appointment-datetime-new-{{ item.id }}">
                                  veya detaylı tarih/saat seç
                                </label>
                                <input
                                  id="appointment-datetime-new-{{ item.id }}"
                                  type="datetime-local"
                                  name="scheduled_for"
                                  data-appointment-datetime
                                >
                                <div class="appointment-summary" data-appointment-summary></div>
                              </div>
                              <textarea name="customer_note" rows="2" placeholder="Randevu notu (isteğe bağlı)"></textarea>
                              <button type="submit" class="btn btn-sm btn-main">
                                <i class="bi bi-calendar-plus me-1"></i>Randevu Al
                              </button>
                            </form>
                          {% endif %}
                        </div>
                      </details>
                      {% else %}
                        <div class="request-action-note">
                          <i class="bi bi-info-circle me-1"></i>Takvim özelliği devre dışı.
                        </div>
                      {% endif %}
                    </div>
                  {% elif item.status == "completed" %}
                    {% if item.matched_provider %}
                      <div class="request-actions-stack">
                        <span class="small text-muted"><i class="bi bi-lock-fill me-1"></i>Mesajlaşma tamamlanan işte kapalı.</span>
                        {% if item.can_rate %}
                          <form method="post" action="{% url 'rate_request' item.id %}" class="request-rate-form">
                            {% csrf_token %}
                            <div class="request-rate-row">
                              <select name="score" required>
                                <option value="">Puan</option>
                                <option value="5" {% if item.rating_entry and item.rating_entry.score == 5 %}selected{% endif %}>5</option>
                                <option value="4" {% if item.rating_entry and item.rating_entry.score == 4 %}selected{% endif %}>4</option>
                                <option value="3" {% if item.rating_entry and item.rating_entry.score == 3 %}selected{% endif %}>3</option>
                                <option value="2" {% if item.rating_entry and item.rating_entry.score == 2 %}selected{% endif %}>2</option>
                                <option value="1" {% if item.rating_entry and item.rating_entry.score == 1 %}selected{% endif %}>1</option>
                              </select>
                              <button type="submit" class="btn btn-sm request-rate-btn">
                                {% if item.rating_entry %}Yorumu Güncelle{% else %}Puanla{% endif %}
                              </button>
                            </div>
                            <textarea name="comment" rows="2" placeholder="Yorum (isteğe bağlı)">{% if item.rating_entry %}{{ item.rating_entry.comment }}{% endif %}</textarea>
                            {% if item.rating_entry %}
                              <div class="small text-muted">
                                Mevcut puanın: {{ item.rating_entry.score }}/5
                                {% if item.rating_entry.updated_at %} - Son güncelleme: {{ item.rating_entry.updated_at|date:"d.m.Y H:i" }}{% endif %}
                              </div>
                            {% endif %}
                          </form>
                        {% else %}
                          <span class="small text-muted"><i class="bi bi-shield-lock me-1"></i>{{ item.rate_block_reason|default:"Bu iş için puanlama kapalı." }}</span>
                        {% endif %}
                      </div>
                    {% else %}
                      <span class="small text-muted">Usta yok</span>
                    {% endif %}
                  {% elif item.status == "pending_customer" %}
                    <div class="request-actions-stack">
                      <div class="request-action-guide">
                        <i class="bi bi-signpost-split me-1"></i>Sıradaki adım: {{ item.flow_next_action }}
                      </div>
                      {% if item.accepted_offers %}
                        {% for offer in item.accepted_offers %}
                          <form method="post" action="{% url 'select_provider_offer' item.id offer.id %}" class="offer-select-form">
                            {% csrf_token %}
                            <div class="offer-select-head">
                              <strong>{{ offer.provider.full_name }}</strong>
                              <a href="{% url 'provider_detail' offer.provider.id %}" class="offer-profile-link">Profili</a>
                              {% if item.recommended_offer_id == offer.id %}
                                <span class="offer-badge">Önerilen</span>
                              {% endif %}
                            </div>
                            <div class="offer-score mb-2">
                              <span>Karşılaştırma Puanı:</span>
                              <strong>{{ offer.comparison_score }}/100</strong>
                            </div>
                            <div class="offer-score-breakdown mb-2">
                              <span>Puan {{ offer.rating_score }}</span>
                              <span>Hız {{ offer.speed_score }}</span>
                            </div>
                            <div class="small text-muted mb-2">
                              Skor formülü: Usta puanı (70) + Hız (30). Hız, teklifin geliş sırasına göre hesaplanır.
                            </div>
                            <div class="small text-muted mb-2">Usta puani: {{ offer.provider.rating }}/5</div>
                            {% if offer.quote_note %}
                              <div class="small text-muted mb-2">{{ offer.quote_note }}</div>
                            {% endif %}
                            <button type="submit" class="btn btn-sm btn-main">
                              <i class="bi bi-person-check me-1"></i>Bu Ustayı Seç
                            </button>
                          </form>
                        {% endfor %}
                      {% else %}
                        <span class="small text-muted">Henüz onaylı teklif yok.</span>
                      {% endif %}
                      <form method="post" action="{% url 'cancel_request' item.id %}" class="m-0">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          <i class="bi bi-x-circle me-1"></i>Talebi İptal Et
                        </button>
                      </form>
                    </div>
                  {% elif item.status == "new" or item.status == "pending_provider" %}
                    <div class="request-actions-stack">
                      <div class="request-action-guide">
                        <i class="bi bi-signpost-split me-1"></i>Sıradaki adım: {{ item.flow_next_action }}
                      </div>
                      <form method="post" action="{% url 'cancel_request' item.id %}" class="m-0">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          <i class="bi bi-x-circle me-1"></i>Aramayı İptal Et
                        </button>
                      </form>
                    </div>
                  {% else %}
                    {% if item.status == "cancelled" %}
                      <form method="post" action="{% url 'delete_cancelled_request' item.id %}" class="m-0">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          <i class="bi bi-trash3 me-1"></i>Sil
                        </button>
                      </form>
                    {% else %}
                      <span class="small text-muted">{{ item.flow_next_action }}</span>
                    {% endif %}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if requests_page_obj.has_other_pages %}
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-3">
          <span class="small text-muted">
            Sayfa {{ requests_page_obj.number }} / {{ requests_page_obj.paginator.num_pages }}
          </span>
          <nav aria-label="Taleplerim sayfalama">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item {% if not requests_page_obj.has_previous %}disabled{% endif %}">
                <a class="page-link" href="?page={% if requests_page_obj.has_previous %}{{ requests_page_obj.previous_page_number }}{% else %}1{% endif %}" aria-label="Önceki">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              <li class="page-item disabled"><span class="page-link">{{ requests_page_obj.number }}</span></li>
              <li class="page-item {% if not requests_page_obj.has_next %}disabled{% endif %}">
                <a class="page-link" href="?page={% if requests_page_obj.has_next %}{{ requests_page_obj.next_page_number }}{% else %}{{ requests_page_obj.paginator.num_pages }}{% endif %}" aria-label="Sonraki">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      {% endif %}
    {% else %}
      <p class="mb-0 text-muted">Henüz talebin yok. Ana sayfadan yeni talep oluşturabilirsin.</p>
    {% endif %}
  </div>
</section>
<script>
  (function () {
    function setupInlineConfirm(options) {
      const formSelector = options.formSelector;
      const openSelector = options.openSelector;
      const boxSelector = options.boxSelector;
      const cancelSelector = options.cancelSelector;
      const forms = document.querySelectorAll(formSelector);
      if (!forms.length) return;

      function closeFormConfirmation(form) {
        const openButton = form.querySelector(openSelector);
        const confirmBox = form.querySelector(boxSelector);
        if (!openButton || !confirmBox) return;
        confirmBox.classList.add("d-none");
        openButton.classList.remove("d-none");
      }

      function closeAllExcept(excludedForm) {
        forms.forEach(function (form) {
          if (form === excludedForm) return;
          closeFormConfirmation(form);
        });
      }

      forms.forEach(function (form) {
        const openButton = form.querySelector(openSelector);
        const confirmBox = form.querySelector(boxSelector);
        const cancelButton = form.querySelector(cancelSelector);
        if (!openButton || !confirmBox) return;

        openButton.addEventListener("click", function () {
          closeAllExcept(form);
          confirmBox.classList.remove("d-none");
          openButton.classList.add("d-none");
        });

        if (cancelButton) {
          cancelButton.addEventListener("click", function () {
            closeFormConfirmation(form);
          });
        }
      });

      document.addEventListener("click", function (event) {
        if (event.target.closest(formSelector)) return;
        closeAllExcept(null);
      });
    }

    setupInlineConfirm({
      formSelector: "form[data-complete-confirm-form]",
      openSelector: "[data-complete-open]",
      boxSelector: "[data-complete-confirm-box]",
      cancelSelector: "[data-complete-cancel]",
    });

    setupInlineConfirm({
      formSelector: "form[data-cancel-confirm-form]",
      openSelector: "[data-cancel-open]",
      boxSelector: "[data-cancel-confirm-box]",
      cancelSelector: "[data-cancel-cancel]",
    });
  })();
</script>
<script>
  (function () {
    const toggleButtons = document.querySelectorAll("[data-request-mobile-toggle]");
    if (!toggleButtons.length) return;

    toggleButtons.forEach(function (button) {
      button.addEventListener("click", function () {
        const row = button.closest("tr.request-row-card");
        if (!row) return;
        const expanded = row.classList.toggle("mobile-expanded");
        button.setAttribute("aria-expanded", expanded ? "true" : "false");
        button.textContent = expanded ? "Kapat" : "Detaylar";
      });
    });
  })();
</script>
{% if calendar_enabled %}
<script>
  (function () {
    const forms = document.querySelectorAll(".appointment-create-form");
    if (!forms.length) return;
    const minLeadMinutes = Number("{{ appointment_min_lead_minutes|default:5 }}") || 5;

    const presetMap = {
      now: { minutes: minLeadMinutes, label: "en erken saat" },
      "30m": { minutes: Math.max(30, minLeadMinutes), label: "30 dakika sonra" },
      "1h": { minutes: Math.max(60, minLeadMinutes), label: "1 saat sonra" },
      "2h": { minutes: Math.max(120, minLeadMinutes), label: "2 saat sonra" },
    };

    function toDateTimeLocal(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      const hours = String(date.getHours()).padStart(2, "0");
      const minutes = String(date.getMinutes()).padStart(2, "0");
      return year + "-" + month + "-" + day + "T" + hours + ":" + minutes;
    }

    function formatHumanDate(date) {
      return new Intl.DateTimeFormat("tr-TR", {
        weekday: "short",
        day: "2-digit",
        month: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      }).format(date);
    }

    function nextDateByMinutes(minutes) {
      const selectedDate = new Date();
      selectedDate.setMinutes(selectedDate.getMinutes() + minutes);
      selectedDate.setSeconds(0, 0);
      return selectedDate;
    }

    forms.forEach(function (form) {
      const scheduler = form.querySelector("[data-appointment-scheduler]");
      if (!scheduler) return;

      const presetInput = scheduler.querySelector("[data-appointment-preset-input]");
      const dateInput = scheduler.querySelector("[data-appointment-datetime]");
      const summary = scheduler.querySelector("[data-appointment-summary]");
      const quickButtons = scheduler.querySelectorAll("[data-appointment-preset-btn]");
      if (!presetInput || !dateInput || !summary || !quickButtons.length) return;

      function updateMinDate() {
        dateInput.min = toDateTimeLocal(nextDateByMinutes(minLeadMinutes));
      }

      function setSummary(text, isError) {
        summary.textContent = text;
        summary.classList.toggle("appointment-summary-error", Boolean(isError));
      }

      function clearActiveButtons() {
        quickButtons.forEach(function (button) {
          button.classList.remove("active");
        });
      }

      function setPresetValue(presetValue) {
        presetInput.value = presetValue || "";
        clearActiveButtons();
        if (!presetValue) return;
        const activeButton = scheduler.querySelector('[data-appointment-preset-btn="' + presetValue + '"]');
        if (activeButton) {
          activeButton.classList.add("active");
        }
      }

      function applyPreset(presetValue) {
        const preset = presetMap[presetValue];
        if (!preset) return;
        const nextDate = nextDateByMinutes(preset.minutes);
        setPresetValue(presetValue);
        dateInput.value = toDateTimeLocal(nextDate);
        dateInput.setCustomValidity("");
        setSummary("Seçilen randevu: " + formatHumanDate(nextDate) + " (" + preset.label + ")", false);
      }

      function applyManualValue() {
        if (!dateInput.value) {
          setPresetValue("");
          setSummary("Hızlı seçim yapın veya detaylı tarih/saat girin.", false);
          return;
        }
        setPresetValue("");
        const parsedDate = new Date(dateInput.value);
        if (Number.isNaN(parsedDate.getTime())) {
          setSummary("Tarih/saat formatı geçersiz.", true);
          return;
        }
        dateInput.setCustomValidity("");
        setSummary("Seçilen randevu: " + formatHumanDate(parsedDate) + " (detaylı seçim)", false);
      }

      quickButtons.forEach(function (button) {
        button.addEventListener("click", function () {
          applyPreset(button.dataset.appointmentPresetBtn || "");
        });
      });

      dateInput.addEventListener("input", applyManualValue);

      form.addEventListener("submit", function (event) {
        updateMinDate();
        if (!presetInput.value && !dateInput.value) {
          event.preventDefault();
          dateInput.setCustomValidity("Lütfen randevu zamanı seçin.");
          dateInput.reportValidity();
          setSummary("Gönderim için randevu zamanı seçmelisiniz.", true);
          return;
        }
        dateInput.setCustomValidity("");
      });

      updateMinDate();
      if (dateInput.value) {
        applyManualValue();
      } else {
        setSummary("Hızlı seçim yapın veya detaylı tarih/saat girin.", false);
      }
    });
  })();
</script>
{% endif %}
<div
  id="customer-live-sync"
  data-snapshot-url="{% url 'customer_requests_snapshot' %}"
  data-signature="{{ customer_requests_signature }}"
  data-pending-customer-requests-count="{{ customer_snapshot.pending_customer_requests_count }}"
  data-matched-requests-count="{{ customer_snapshot.matched_requests_count }}"
  data-pending-customer-appointments-count="{{ customer_snapshot.pending_customer_appointments_count }}"
  data-confirmed-appointments-count="{{ customer_snapshot.confirmed_appointments_count }}"
  data-accepted-offers-count="{{ customer_snapshot.accepted_offers_count }}"
  data-unread-messages-count="{{ customer_snapshot.unread_messages_count }}"
></div>
<script>
  (function () {
    const syncRoot = document.getElementById("customer-live-sync");
    if (!syncRoot) return;
    const snapshotUrl = syncRoot.dataset.snapshotUrl;
    if (!snapshotUrl) return;

    const defaultTitle = document.title;
    let titleFlashTimer = null;
    let titleFlashOn = false;
    let reloadTimer = null;
    let polling = false;
    const badgeCountKey = "ustabul_customer_unseen_count";
    const snapshotKey = "ustabul_customer_last_snapshot";
    let baseline = {
      signature: syncRoot.dataset.signature || "",
      pendingCustomerRequestsCount: Number(syncRoot.dataset.pendingCustomerRequestsCount || 0),
      matchedRequestsCount: Number(syncRoot.dataset.matchedRequestsCount || 0),
      pendingCustomerAppointmentsCount: Number(syncRoot.dataset.pendingCustomerAppointmentsCount || 0),
      confirmedAppointmentsCount: Number(syncRoot.dataset.confirmedAppointmentsCount || 0),
      acceptedOffersCount: Number(syncRoot.dataset.acceptedOffersCount || 0),
      unreadMessagesCount: Number(syncRoot.dataset.unreadMessagesCount || 0),
    };

    function renderNavBadge(selector, count) {
      const targets = document.querySelectorAll(selector);
      if (!targets.length) return;
      targets.forEach(function (target) {
        let badge = target.querySelector(".nav-live-badge");
        if (!count) {
          if (badge) badge.remove();
          return;
        }
        if (!badge) {
          badge = document.createElement("span");
          badge.className = "nav-live-badge";
          target.appendChild(badge);
        }
        badge.textContent = count > 99 ? "99+" : String(count);
      });
    }

    function buildCustomerSnapshot(state) {
      return {
        acceptedOffersCount: Number(state.acceptedOffersCount || 0),
        pendingCustomerAppointmentsCount: Number(state.pendingCustomerAppointmentsCount || 0),
        confirmedAppointmentsCount: Number(state.confirmedAppointmentsCount || 0),
        unreadMessagesCount: Number(state.unreadMessagesCount || 0),
        pendingCustomerRequestsCount: Number(state.pendingCustomerRequestsCount || 0),
        matchedRequestsCount: Number(state.matchedRequestsCount || 0),
        signature: state.signature || "",
      };
    }

    function markCustomerNotificationsSeen(state) {
      const snapshot = buildCustomerSnapshot(state);
      try {
        localStorage.setItem(badgeCountKey, "0");
        localStorage.setItem(snapshotKey, JSON.stringify(snapshot));
      } catch (error) {
        void error;
      }
      renderNavBadge("[data-live-customer-nav]", 0);
    }

    function stopTitleFlash() {
      if (!titleFlashTimer) return;
      window.clearInterval(titleFlashTimer);
      titleFlashTimer = null;
      titleFlashOn = false;
      document.title = defaultTitle;
    }

    function flashTitle(message) {
      if (!document.hidden) return;
      stopTitleFlash();
      titleFlashTimer = window.setInterval(function () {
        titleFlashOn = !titleFlashOn;
        document.title = titleFlashOn ? "* " + message : defaultTitle;
      }, 900);
      window.setTimeout(stopTitleFlash, 10000);
    }

    function showInlineNotice(message) {
      let toast = document.getElementById("customer-live-notice");
      if (!toast) {
        toast = document.createElement("div");
        toast.id = "customer-live-notice";
        toast.className = "live-sync-toast";
        document.body.appendChild(toast);
      }
      toast.innerHTML = '<i class="bi bi-bell-fill"></i><span>' + message + "</span>";
      toast.classList.add("show");
      window.setTimeout(function () {
        toast.classList.remove("show");
      }, 2600);
    }

    function triggerLiveAlert(message) {
      if (!message) return;
      showInlineNotice(message);
      document.body.classList.add("live-sync-attention");
      window.setTimeout(function () {
        document.body.classList.remove("live-sync-attention");
      }, 1500);
      flashTitle(message);
    }

    function scheduleReload(delayMs) {
      if (reloadTimer) return;
      reloadTimer = window.setTimeout(function () {
        window.location.reload();
      }, delayMs);
    }

    function parseCustomerState(payload) {
      return {
        signature: payload.signature || "",
        pendingCustomerRequestsCount: Number(payload.pending_customer_requests_count || 0),
        matchedRequestsCount: Number(payload.matched_requests_count || 0),
        pendingCustomerAppointmentsCount: Number(payload.pending_customer_appointments_count || 0),
        confirmedAppointmentsCount: Number(payload.confirmed_appointments_count || 0),
        acceptedOffersCount: Number(payload.accepted_offers_count || 0),
        unreadMessagesCount: Number(payload.unread_messages_count || 0),
      };
    }

    function handleNextState(nextState) {
      const hasChanges =
        nextState.signature !== baseline.signature ||
        nextState.pendingCustomerRequestsCount !== baseline.pendingCustomerRequestsCount ||
        nextState.matchedRequestsCount !== baseline.matchedRequestsCount ||
        nextState.pendingCustomerAppointmentsCount !== baseline.pendingCustomerAppointmentsCount ||
        nextState.confirmedAppointmentsCount !== baseline.confirmedAppointmentsCount ||
        nextState.acceptedOffersCount !== baseline.acceptedOffersCount ||
        nextState.unreadMessagesCount !== baseline.unreadMessagesCount;

      if (!hasChanges) return;

      let message = "Talepleriniz guncellendi.";
      if (
        nextState.acceptedOffersCount > baseline.acceptedOffersCount ||
        nextState.pendingCustomerRequestsCount > baseline.pendingCustomerRequestsCount
      ) {
        message = "Bir usta isinizi kabul etti. Teklifleri kontrol edin.";
      } else if (nextState.unreadMessagesCount > baseline.unreadMessagesCount) {
        message = "Yeni bir mesajiniz var.";
      } else if (nextState.confirmedAppointmentsCount > baseline.confirmedAppointmentsCount) {
        message = "Randevunuz usta tarafindan onaylandi.";
      } else if (nextState.pendingCustomerAppointmentsCount > baseline.pendingCustomerAppointmentsCount) {
        message = "Onayinizi bekleyen yeni bir randevu var.";
      } else if (nextState.matchedRequestsCount > baseline.matchedRequestsCount) {
        message = "Talebiniz bir usta ile eslesti.";
      }

      baseline = nextState;
      markCustomerNotificationsSeen(nextState);
      triggerLiveAlert(message);
      scheduleReload(1500);
    }

    async function pollCustomerRequests() {
      if (document.hidden || polling) return;
      polling = true;
      try {
        const response = await fetch(snapshotUrl, {
          method: "GET",
          credentials: "same-origin",
          headers: { "X-Requested-With": "XMLHttpRequest" },
          cache: "no-store",
        });
        if (!response.ok) return;
        const payload = await response.json();
        handleNextState(parseCustomerState(payload));
      } catch (error) {
        void error;
      } finally {
        polling = false;
      }
    }

    document.addEventListener("visibilitychange", function () {
      if (!document.hidden) {
        stopTitleFlash();
        pollCustomerRequests();
      }
    });

    window.addEventListener("ustabul:nav-snapshot", function (event) {
      const detail = event ? event.detail : null;
      if (!detail || detail.role !== "customer") return;
      handleNextState(parseCustomerState(detail.payload || {}));
    });

    markCustomerNotificationsSeen(baseline);
    window.setInterval(pollCustomerRequests, 45000);
    pollCustomerRequests();
  })();
</script>
{% endblock %}
