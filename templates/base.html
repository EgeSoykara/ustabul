{% load static %}
<!doctype html>
<html lang="tr" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0e7490">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>UstaBul</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="manifest" href="{% static 'pwa/manifest.webmanifest' %}">
  <link rel="icon" type="image/svg+xml" href="{% static 'pwa/favicon.svg' %}?v=20260228-1">
  <link rel="alternate icon" type="image/png" href="{% static 'pwa/icon-192.png' %}?v=20260228-1">
  <link rel="apple-touch-icon" href="{% static 'pwa/icon-192.png' %}">
  <link rel="stylesheet" href="{% static 'css/style.css' %}?v=20260301-9">
</head>
<body>
<div class="bg-orb orb-a"></div>
<div class="bg-orb orb-b"></div>
<div class="bg-orb orb-c"></div>
<div class="bg-noise"></div>

<header class="site-header fixed-top">
  <div class="container">
    <nav class="navbar navbar-expand-lg site-nav">
      <a class="navbar-brand site-brand" href="{% url 'index' %}">
        <span class="site-brand-mark"><i class="bi bi-tools"></i></span>
        <span class="site-brand-copy">
          <strong>UstaBul</strong>
          <small>Yerli Hizmet Platformu</small>
        </span>
      </a>

      <button class="navbar-toggler nav-toggle-btn" type="button" data-bs-toggle="collapse" data-bs-target="#siteNav" aria-controls="siteNav" aria-expanded="false" aria-label="Menüyü aç">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="siteNav">
        <div class="navbar-nav nav-links ms-lg-4">
          <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="{% url 'index' %}"><i class="bi bi-house-door me-1"></i>Ana Sayfa</a>
          {% if request.user.is_authenticated and request.session.role == "provider" %}
            <a class="nav-link {% if request.path == '/usta/talepler/' %}active{% endif %}" href="{% url 'provider_requests' %}" data-live-provider-nav><i class="bi bi-briefcase me-1"></i>Usta Paneli</a>
            <a class="nav-link {% if request.path == '/anlasmalar/' %}active{% endif %}" href="{% url 'agreement_history' %}"><i class="bi bi-journal-check me-1"></i>Anlaşmalar</a>
            <a class="nav-link {% if request.path == '/usta/profil/' %}active{% endif %}" href="{% url 'provider_profile' %}"><i class="bi bi-person-vcard me-1"></i>Usta Profili</a>
          {% elif request.user.is_authenticated %}
            <a class="nav-link {% if request.path == '/taleplerim/' %}active{% endif %}" href="{% url 'my_requests' %}" data-live-customer-nav><i class="bi bi-kanban me-1"></i>Taleplerim</a>
            <a class="nav-link {% if request.path == '/anlasmalar/' %}active{% endif %}" href="{% url 'agreement_history' %}"><i class="bi bi-journal-check me-1"></i>Anlaşmalar</a>
          {% endif %}
          {% if request.user.is_authenticated and request.user.is_staff %}
            <a class="nav-link {% if request.path == '/operasyon/' %}active{% endif %}" href="{% url 'operations_dashboard' %}">
              <i class="bi bi-speedometer2 me-1"></i>Operasyon
            </a>
          {% endif %}
          {% if request.user.is_authenticated %}
            <a class="nav-link nav-notification-link {% if request.path == '/bildirimler/' %}active{% endif %}" href="{% url 'notifications' %}">
              <i class="bi bi-bell me-1"></i>Bildirimler
              {% if nav_unread_notifications_count %}
                <span class="nav-live-badge">
                  {% if nav_unread_notifications_count > 99 %}99+{% else %}{{ nav_unread_notifications_count }}{% endif %}
                </span>
              {% endif %}
            </a>
          {% endif %}
          <a class="nav-link {% if request.path == '/contact/' %}active{% endif %}" href="{% url 'contact' %}"><i class="bi bi-chat-dots me-1"></i>İletişim</a>
        </div>

        <div class="nav-tools ms-lg-auto">
          {% if request.user.is_authenticated %}
            <span class="user-chip d-none d-md-inline-flex"><i class="bi bi-person-circle me-1"></i>{{ request.user.username }}</span>
            {% if request.session.role == "provider" %}
              <a class="btn nav-cta-btn d-none d-md-inline-flex" href="{% url 'provider_requests' %}" data-live-provider-nav>
                <i class="bi bi-briefcase-fill me-1"></i>Usta Paneli
              </a>
            {% else %}
              <a class="btn nav-cta-btn d-none d-md-inline-flex" href="{% url 'index' %}#talep-form">
                <i class="bi bi-lightning-charge-fill me-1"></i>Talep Aç
              </a>
            {% endif %}
            <form method="post" action="{% url 'logout' %}" class="logout-form">
              {% csrf_token %}
              <button type="submit" class="btn nav-ghost-btn"><i class="bi bi-box-arrow-right me-1"></i>Çıkış</button>
            </form>
          {% else %}
            <a class="btn nav-ghost-btn" href="{% url 'customer_login' %}"><i class="bi bi-box-arrow-in-right me-1"></i>Müşteri Girişi</a>
            <a class="btn nav-ghost-btn" href="{% url 'provider_login' %}"><i class="bi bi-tools me-1"></i>Usta Girişi</a>
            <a class="btn nav-ghost-btn" href="{% url 'provider_signup' %}"><i class="bi bi-briefcase-fill me-1"></i>Usta Kaydı</a>
            <a class="btn nav-cta-btn" href="{% url 'customer_signup' %}"><i class="bi bi-person-plus-fill me-1"></i>Müşteri Kaydı</a>
          {% endif %}
          <button type="button" class="theme-toggle-btn" id="theme-toggle-btn" aria-label="Temayı değiştir">
            <i class="bi bi-moon-stars-fill"></i>
          </button>
        </div>
      </div>
    </nav>
  </div>
</header>

<main class="container site-main">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags|default:'info' }}" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
  {% block content %}{% endblock %}
</main>
<button id="pwa-install-btn" class="pwa-install-btn" type="button" hidden>
  <i class="bi bi-phone-fill me-1"></i>Uygulamayı Yükle
</button>

<script>
  (function () {
    const root = document.documentElement;
    const btn = document.getElementById("theme-toggle-btn");
    if (!btn) return;

    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark" || savedTheme === "light") {
      root.setAttribute("data-theme", savedTheme);
    } else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
      root.setAttribute("data-theme", "dark");
    }

    const updateIcon = function () {
      const isDark = root.getAttribute("data-theme") === "dark";
      btn.innerHTML = isDark
        ? '<i class="bi bi-brightness-high-fill"></i>'
        : '<i class="bi bi-moon-stars-fill"></i>';
    };

    updateIcon();
    btn.addEventListener("click", function () {
      const next = root.getAttribute("data-theme") === "dark" ? "light" : "dark";
      root.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
      updateIcon();
    });
  })();
</script>
<script>
  (function () {
    const phoneInputs = document.querySelectorAll("input[data-phone-field]");
    if (!phoneInputs.length) return;

    function normalizeDigits(value) {
      let digits = (value || "").replace(/\D/g, "");
      if (digits.startsWith("90") && digits.length === 12) {
        digits = "0" + digits.slice(2);
      } else if (digits.length === 10 && digits.startsWith("5")) {
        digits = "0" + digits;
      }
      if (digits.length > 11) {
        digits = digits.slice(0, 11);
      }
      return digits;
    }

    function formatPhone(value) {
      const digits = normalizeDigits(value);
      if (digits.length <= 4) return digits;
      if (digits.length <= 7) return digits.slice(0, 4) + " " + digits.slice(4);
      if (digits.length <= 9) return digits.slice(0, 4) + " " + digits.slice(4, 7) + " " + digits.slice(7);
      return digits.slice(0, 4) + " " + digits.slice(4, 7) + " " + digits.slice(7, 9) + " " + digits.slice(9, 11);
    }

    phoneInputs.forEach(function (input) {
      const applyFormatting = function () {
        input.value = formatPhone(input.value);
      };

      input.addEventListener("input", applyFormatting);
      input.addEventListener("blur", applyFormatting);
      if (input.value) {
        applyFormatting();
      }
    });
  })();
</script>
<script>
  (function () {
    if (!("serviceWorker" in navigator)) return;
    window.addEventListener("load", function () {
      navigator.serviceWorker
        .register("/service-worker.js")
        .then(function (registration) {
          registration.update();
        })
        .catch(function () {});
    });
  })();
</script>
<script>
  (function () {
    const installBtn = document.getElementById("pwa-install-btn");
    if (!installBtn) return;

    const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
    if (isStandalone) return;

    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", function (event) {
      event.preventDefault();
      deferredPrompt = event;
      installBtn.hidden = false;
    });

    installBtn.addEventListener("click", async function () {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      try {
        await deferredPrompt.userChoice;
      } catch (error) {
        void error;
      }
      deferredPrompt = null;
      installBtn.hidden = true;
    });

    window.addEventListener("appinstalled", function () {
      installBtn.hidden = true;
      deferredPrompt = null;
    });
  })();
</script>
<script>
  (function () {
    const isAuthenticated = {% if request.user.is_authenticated %}true{% else %}false{% endif %};
    if (!isAuthenticated) return;

    if (document.getElementById("provider-live-sync") || document.getElementById("customer-live-sync")) {
      return;
    }

    const isProvider = {% if request.user.is_authenticated and request.session.role == "provider" %}true{% else %}false{% endif %};
    const snapshotUrl = isProvider
      ? "{% url 'provider_panel_snapshot' %}"
      : "{% url 'customer_requests_snapshot' %}";
    const streamUrl = "{% url 'nav_live_stream' %}";
    const navSelector = isProvider ? "[data-live-provider-nav]" : "[data-live-customer-nav]";
    const badgeCountKey = isProvider ? "ustabul_provider_unseen_count" : "ustabul_customer_unseen_count";
    const snapshotKey = isProvider ? "ustabul_provider_last_snapshot" : "ustabul_customer_last_snapshot";

    function renderNavBadge(count) {
      const targets = document.querySelectorAll(navSelector);
      if (!targets.length) return;
      targets.forEach(function (target) {
        let badge = target.querySelector(".nav-live-badge");
        if (!count) {
          if (badge) badge.remove();
          return;
        }
        if (!badge) {
          badge = document.createElement("span");
          badge.className = "nav-live-badge";
          target.appendChild(badge);
        }
        badge.textContent = count > 99 ? "99+" : String(count);
      });
    }

    function readBadgeCount() {
      try {
        const raw = Number(localStorage.getItem(badgeCountKey) || 0);
        return Number.isFinite(raw) && raw > 0 ? raw : 0;
      } catch (error) {
        void error;
        return 0;
      }
    }

    function writeBadgeCount(value) {
      const safeValue = Number.isFinite(value) && value > 0 ? Math.floor(value) : 0;
      try {
        localStorage.setItem(badgeCountKey, String(safeValue));
      } catch (error) {
        void error;
      }
      renderNavBadge(safeValue);
    }

    function readSnapshot() {
      try {
        const raw = localStorage.getItem(snapshotKey);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (error) {
        void error;
        return null;
      }
    }

    function writeSnapshot(snapshot) {
      try {
        localStorage.setItem(snapshotKey, JSON.stringify(snapshot));
      } catch (error) {
        void error;
      }
    }

    function buildProviderSnapshot(payload) {
      return {
        pendingOffersCount: Number(payload.pending_offers_count || 0),
        latestPendingOfferId: Number(payload.latest_pending_offer_id || 0),
        pendingAppointmentsCount: Number(payload.pending_appointments_count || 0),
        unreadMessagesCount: Number(payload.unread_messages_count || 0),
      };
    }

    function buildCustomerSnapshot(payload) {
      return {
        acceptedOffersCount: Number(payload.accepted_offers_count || 0),
        pendingCustomerAppointmentsCount: Number(payload.pending_customer_appointments_count || 0),
        confirmedAppointmentsCount: Number(payload.confirmed_appointments_count || 0),
        unreadMessagesCount: Number(payload.unread_messages_count || 0),
        pendingCustomerRequestsCount: Number(payload.pending_customer_requests_count || 0),
        matchedRequestsCount: Number(payload.matched_requests_count || 0),
        signature: String(payload.signature || ""),
      };
    }

    function getProviderIncrement(previous, nextState) {
      if (!previous) return 0;
      let increment = 0;
      if (nextState.pendingOffersCount > (previous.pendingOffersCount || 0)) {
        increment += nextState.pendingOffersCount - (previous.pendingOffersCount || 0);
      } else if (
        nextState.latestPendingOfferId > (previous.latestPendingOfferId || 0) &&
        nextState.pendingOffersCount >= (previous.pendingOffersCount || 0)
      ) {
        increment += 1;
      }
      if (nextState.pendingAppointmentsCount > (previous.pendingAppointmentsCount || 0)) {
        increment += nextState.pendingAppointmentsCount - (previous.pendingAppointmentsCount || 0);
      }
      if (nextState.unreadMessagesCount > (previous.unreadMessagesCount || 0)) {
        increment += nextState.unreadMessagesCount - (previous.unreadMessagesCount || 0);
      }
      return increment;
    }

    function getCustomerIncrement(previous, nextState) {
      if (!previous) return 0;
      let increment = 0;
      if (nextState.acceptedOffersCount > (previous.acceptedOffersCount || 0)) {
        increment += nextState.acceptedOffersCount - (previous.acceptedOffersCount || 0);
      }
      if (nextState.pendingCustomerRequestsCount > (previous.pendingCustomerRequestsCount || 0)) {
        increment += nextState.pendingCustomerRequestsCount - (previous.pendingCustomerRequestsCount || 0);
      }
      if (nextState.pendingCustomerAppointmentsCount > (previous.pendingCustomerAppointmentsCount || 0)) {
        increment += nextState.pendingCustomerAppointmentsCount - (previous.pendingCustomerAppointmentsCount || 0);
      }
      if (nextState.confirmedAppointmentsCount > (previous.confirmedAppointmentsCount || 0)) {
        increment += nextState.confirmedAppointmentsCount - (previous.confirmedAppointmentsCount || 0);
      }
      if (nextState.unreadMessagesCount > (previous.unreadMessagesCount || 0)) {
        increment += nextState.unreadMessagesCount - (previous.unreadMessagesCount || 0);
      }
      if (nextState.matchedRequestsCount > (previous.matchedRequestsCount || 0)) {
        increment += nextState.matchedRequestsCount - (previous.matchedRequestsCount || 0);
      }
      if (!increment && nextState.signature !== (previous.signature || "")) {
        increment = 1;
      }
      return increment;
    }

    let pollingTimerId = null;
    let reconnectTimerId = null;
    let streamInstance = null;

    function emitNavSnapshotEvent(payload) {
      if (!payload || typeof payload !== "object") return;
      try {
        window.dispatchEvent(
          new CustomEvent("ustabul:nav-snapshot", {
            detail: {
              role: isProvider ? "provider" : "customer",
              payload: payload,
            },
          })
        );
      } catch (error) {
        void error;
      }
    }

    function applySnapshotPayload(payload) {
      const previousSnapshot = readSnapshot();
      const nextSnapshot = isProvider ? buildProviderSnapshot(payload) : buildCustomerSnapshot(payload);
      const increment = isProvider
        ? getProviderIncrement(previousSnapshot, nextSnapshot)
        : getCustomerIncrement(previousSnapshot, nextSnapshot);
      if (increment > 0) {
        writeBadgeCount(readBadgeCount() + increment);
      }
      writeSnapshot(nextSnapshot);
      emitNavSnapshotEvent(payload);
    }

    async function pollNavNotifications() {
      if (document.hidden) return;
      try {
        const response = await fetch(snapshotUrl, {
          method: "GET",
          credentials: "same-origin",
          headers: { "X-Requested-With": "XMLHttpRequest" },
          cache: "no-store",
        });
        if (!response.ok) return;
        const payload = await response.json();
        applySnapshotPayload(payload);
      } catch (error) {
        void error;
      }
    }

    function stopPolling() {
      if (pollingTimerId === null) return;
      window.clearInterval(pollingTimerId);
      pollingTimerId = null;
    }

    function startPolling() {
      if (pollingTimerId !== null) return;
      pollingTimerId = window.setInterval(pollNavNotifications, 10000);
      pollNavNotifications();
    }

    function closeStream() {
      if (!streamInstance) return;
      streamInstance.close();
      streamInstance = null;
    }

    function scheduleReconnect(delayMs) {
      if (reconnectTimerId !== null) return;
      reconnectTimerId = window.setTimeout(function () {
        reconnectTimerId = null;
        connectLiveStream();
      }, delayMs);
    }

    function connectLiveStream() {
      if (!("EventSource" in window)) {
        startPolling();
        return;
      }

      closeStream();
      try {
        streamInstance = new EventSource(streamUrl, { withCredentials: true });
      } catch (error) {
        void error;
        startPolling();
        scheduleReconnect(5000);
        return;
      }

      streamInstance.addEventListener("snapshot", function (event) {
        if (!event || !event.data) return;
        try {
          const payload = JSON.parse(event.data);
          applySnapshotPayload(payload);
          stopPolling();
        } catch (error) {
          void error;
        }
      });

      streamInstance.addEventListener("end", function () {
        closeStream();
        startPolling();
        scheduleReconnect(800);
      });

      streamInstance.onerror = function () {
        closeStream();
        startPolling();
        scheduleReconnect(5000);
      };
    }

    document.addEventListener("visibilitychange", function () {
      if (!document.hidden) {
        if (pollingTimerId !== null) {
          pollNavNotifications();
        }
      }
    });

    renderNavBadge(readBadgeCount());
    connectLiveStream();
  })();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
</body>
</html>
